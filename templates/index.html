<html xmlns="http://www.w3.org/1999/html">
<head>
    <title>{{.title}}</title>
    <link rel="stylesheet" href="css/index.css">
</head>
<body>
<div class="userLogin">
    <div class="form-box">
        <div class="button-box">
            <div id="btn"></div>
            <button type="button" class="toggle-btn" onclick="login()">Log In</button>
            <button type="button" class="toggle-btn1" onclick="register()">Register</button>
        </div>
        <form id="login" class="input-group">
            <label for="email">Email</label>
            <input type="email" id="email" class="input-field" name="email" placeholder="Enter Email" required>
            <label for="password">Password</label>
            <input type="password" id="password" class="input-field" name="password" placeholder="Enter Password"
                   required>
            <button type="submit" class="submit-btn">Log In</button>
        </form>
        <form id="register1" class="input-group">
            <label for="first_name1">First Name</label>
            <input type="text" id="first_name1" class="input-field" name="firstName" placeholder="Enter First Name"
                   required>
            <label for="last_name1">Last Name</label>
            <input type="text" id="last_name1" class="input-field" name="lastName" placeholder="Enter Last Name"
                   required>
            <label for="email1">Email</label>
            <input type="email" id="email1" class="input-field" name="email" placeholder="Enter Email" required>
            <label for="password1">Password</label>
            <input type="password" id="password1" class="input-field" name="password" placeholder="Enter Password"
                   required>
            <button type="submit" class="submit-btn">Register</button>
        </form>
    </div>
</div>
<script>
    let x = document.getElementById("login");
    let y = document.getElementById("register1");
    let z = document.getElementById("btn");

    function register() {
        x.style.left = "-400px"
        y.style.left = "50px"
        z.style.left = "110px"
    }

    function login() {
        x.style.left = "50px"
        y.style.left = "450px"
        z.style.left = "0"
    }

    const myForm = document.getElementById('register1');
    let addUserURL = '/api/add-user';
    let generateTokenURL = '/api/generate-token';
    let slotApiURL = '/api/slot';

    myForm.addEventListener('submit', function (e) {
        e.preventDefault();

        const formData = new FormData(this);
        let email = formData.get("email");
        let data;
        fetch(addUserURL, {
            method: 'POST',
            body: JSON.stringify(Object.fromEntries(formData))
        }).then(function (response) {
            if (response.ok) {
                return response.json();
            } else {
                alert("Email already exists");
                return Promise.reject(response);
            }
        }).then(function (json) {
            data = json;
            fetch(generateTokenURL, {
                method: 'POST',
                body: JSON.stringify(Object.fromEntries(formData))
            }).then(function (response) {
                if (response.ok) {
                    return response.json();
                } else {
                    return Promise.reject(response);
                }
            }).then(function (tokenJson) {
                window.localStorage.setItem(email, tokenJson.token);

            }).catch(function (error) {
                console.warn(error);
            })
        }).catch(function (error) {
            console.warn(error);
        })
        let token = window.localStorage.getItem(email);
        if (token) {
            token = "Bearer " + token;
            fetch(slotApiURL, {
                method: 'GET',
                // headers: {
                //     'Authorization': token,
                // }
            }).then(function (response) {
                if (response.ok) {
                    return response.json();
                } else {
                    return Promise.reject(response);
                }
            }).catch(function (error) {
                console.warn(error);
            })
        }
    });

    const myFormLogin = document.getElementById('login');

    myFormLogin.addEventListener('submit', function (e) {
        e.preventDefault();

        const formData = new FormData(this);
        const email = formData.get("email");

        fetch(generateTokenURL, {
            method: 'POST',
            body: JSON.stringify(Object.fromEntries(formData))
        }).then(function (response) {
            if (response.ok) {
                return response.json();
            } else {
                return Promise.reject(response);
            }
        }).then(function (tokenJson) {
            window.localStorage.setItem(email, tokenJson.token);
            let tokenForLogin = window.localStorage.getItem(email);
            //http.request(`http://localhost:8080/api/v1/get-slot?key=value`, {'Authorization': "Bearer" + tokenForLogin}).on('response', (response) => response.pipe(res))
            window.location.href="http://localhost:8080/api/v1/get-slot",{'Authorization': "Bearer" + tokenForLogin};
        }).catch(function (error) {
            console.warn(error);
        })


        // let token = window.localStorage.getItem(email);
        // console.log(token);
        // if (token) {
        //     token = "Bearer " + token;
        //     fetch(slotApiURL, {
        //         method: 'GET',
        //         headers: {
        //              'Authorization': token,
        //         }
        //     }).then(function (response) {
        //         if (response.ok) {
        //             return response.json();
        //         } else {
        //             return Promise.reject(response);
        //         }
        //     }).catch(function (error) {
        //         console.warn(error);
        //     })
        // }
    });
</script>
</body>
</html>