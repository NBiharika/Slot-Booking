<html xmlns="http://www.w3.org/1999/html">
<head>
    <title>{{.title}}</title>
    <link rel="stylesheet" href="css/index1.css">
</head>
<body>
<div id="slot-api"></div>
<div class="userLogin" id="user-login">
    <div class="form-box">
        <div class="button-box">
            <div id="btn"></div>
            <button type="button" class="toggle-btn" onclick="login()">Log In</button>
            <button type="button" class="toggle-btn1" onclick="register()">Register</button>
        </div>
        <form id="login" class="input-group" onLoad="checkCookie()">
            <label for="email">Email</label>
            <input type="email" id="email" class="input-field" name="email" placeholder="Enter Email" required>
            <label for="password">Password</label>
            <input type="password" id="password" class="input-field" name="password" placeholder="Enter Password"
                   required>
            <button type="submit" class="submit-btn">Log In</button>
        </form>
        <form id="register1" class="input-group">
            <label for="first_name1">First Name</label>
            <input type="text" id="first_name1" class="input-field" name="firstName" placeholder="Enter First Name"
                   required>
            <label for="last_name1">Last Name</label>
            <input type="text" id="last_name1" class="input-field" name="lastName" placeholder="Enter Last Name"
                   required>
            <label for="email1">Email</label>
            <input type="email" id="email1" class="input-field" name="email" placeholder="Enter Email" required>
            <label for="password1">Password</label>
            <input type="password" id="password1" class="input-field" name="password" placeholder="Enter Password"
                   required>
            <button type="submit" class="submit-btn">Register</button>
        </form>
    </div>
</div>
<script>
    let x = document.getElementById("login");
    let y = document.getElementById("register1");
    let z = document.getElementById("btn");

    function register() {
        x.style.left = "-400px"
        y.style.left = "50px"
        z.style.left = "110px"
    }

    function login() {
        x.style.left = "50px"
        y.style.left = "450px"
        z.style.left = "0"
    }

    let addUserURL = '/api/add-user';
    let generateTokenURL = '/api/generate-token';
    let slotApiURL = '/api/v1/get-slot';

    const myForm = document.getElementById('register1');

    myForm.addEventListener('submit', function (e) {
        e.preventDefault();

        const formData = new FormData(this);
        let email = formData.get("email");
        let data;
        fetch(addUserURL, {
            method: 'POST',
            body: JSON.stringify(Object.fromEntries(formData))
        }).then(function (response) {
            if (response.ok) {
                return response.json();
            } else {
                return Promise.reject(response);
            }
        }).then(function (json) {
            data = json;
            fetch(generateTokenURL, {
                method: 'POST',
                body: JSON.stringify(Object.fromEntries(formData))
            }).then(function (response) {
                if (response.ok) {
                    return response.json();
                } else {
                    return Promise.reject(response);
                }
            }).then(function (tokenJson) {
                //window.localStorage.setItem("token", tokenJson.token);
                //let token = window.localStorage.getItem("token");
                setCookie("token", tokenJson.token, 1);
                let token = getCookie("token");
                if (token) {
                    alert("Your token is:" + token);
                    token = "Bearer " + token;
                    fetch(slotApiURL, {
                        method: 'GET',
                        headers: {
                            'content-type': 'application/json',
                            'Authorization': token,
                            'Accept': 'application/json',
                        }
                    }).then(function (response) {
                        if (response.ok) {
                            return response.text();
                        } else {
                            return Promise.reject(response);
                        }
                    }).then(function (slots) {
                        console.log(slots)
                        let x = document.getElementById("user-login");
                        x.style.display = 'none';
                        //window.location.href = 'http://localhost:8080/api/v1/get-slot'
                        window.location.assign('http://localhost:8080/api/v1/get-slot')
                        //document.getElementById("slot-api").innerHTML = slots;
                    }).catch(function (error) {

                        console.warn(error);
                    })
                }
            }).catch(function (error) {
                console.warn(error);
            })
        }).catch(function (error) {
            alert("email already exists")
            console.warn(error);
        })
    });

    const myFormLogin = document.getElementById('login');

    myFormLogin.addEventListener('submit', function (e) {
        e.preventDefault();

        const formData = new FormData(this);
        const email = formData.get("email");

        fetch(generateTokenURL, {
            method: 'POST',
            body: JSON.stringify(Object.fromEntries(formData)),
        }).then(function (response) {
            if (response.ok) {
                return response.json();
            } else {
                return Promise.reject(response);
            }
        }).then(function (tokenJson) {
            //window.localStorage.setItem("token", tokenJson.token);
            //let token = window.localStorage.getItem("token");
            setCookie("token", tokenJson.token, 1);
            let token = getCookie("token");
            if (token) {
                token = "Bearer " + token;
                fetch(slotApiURL, {
                    method: 'GET',
                    headers: {
                        'content-type': 'application/json',
                        'Authorization': token,
                        'Accept': 'application/json',
                    },
                }).then(function (response) {
                    if (response.ok) {
                        //window.location.assign('http://localhost:8080/api/v1/get-slot')
                        //window.location.href= './'
                        return response.text();
                    } else {
                        return Promise.reject(response);
                    }
                }).then(function (slots) {
                    console.log(slots)
                    let x = document.getElementById("user-login");
                    x.style.display = 'none';
                    document.getElementById("slot-api").innerHTML = '/api/v1/get-slot';
                    //document.getElementById("slot-api").innerHTML = slots
                }).catch(function (error) {
                    alert("no token provided")
                    console.warn(error);
                })
            }
        }).catch(function (error) {
            alert("invalid credentials");
            console.warn(error);
        })
    });

    function setCookie(cname, cvalue, exdays) {
        const d = new Date();
        d.setTime(d.getTime() + (exdays * 24 * 60 * 60 * 1000));
        let expires = "expires=" + d.toUTCString();
        document.cookie = cname + "=" + cvalue + ";" + expires + ";path=/";
    }

    function getCookie(cname) {
        let name = cname + "=";
        let decodedCookie = decodeURIComponent(document.cookie);
        let ca = decodedCookie.split(';');
        for (let i = 0; i < ca.length; i++) {
            let c = ca[i];
            while (c.charAt(0) == ' ') {
                c = c.substring(1);
            }
            if (c.indexOf(name) == 0) {
                return c.substring(name.length, c.length);
            }
        }
        return "";
    }

    function checkCookie() {
        let token = getCookie("token");
        if (token) {
            alert("Your token is:" + token);
            window.location = '/';
        }
    }
</script>
</body>
</html>